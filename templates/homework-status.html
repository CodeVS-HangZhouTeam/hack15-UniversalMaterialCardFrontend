<style>
    .homework-status-card.mdl-card {
        width: calc(100% - 40px);
        margin: 20px;
    }

    .homework-status-card > .mdl-card__title {
        color: #fff;
        #height: 256px;
        #background: blue center / cover;
    }

    .homework-status-card > .mdl-card__menu {
        color: #fff;
    }
</style>

<div class="homework-status-card mdl-card mdl-shadow--2dp">
    <div class="mdl-card__title" id="chart-container">
        <a class="card_title">作业提交状态</a>
    </div>
    <div id="homework-status-card-chart">

    </div>
</div>
<script type="application/json" id="homework-status-card-data"></script>

<script>
    $.getJSON("http://h15.swineson.cn:18880/query/all", function(json) {
        var result = {
            correct: 0,
            error_count: 0,
            error: {},
            notsubmitted: 0
        };
        json.d.forEach(function(x){
            if (!x.iserror) { result.correct++; }
            else {
                result.error_count++;
                if (typeof result.error[x.error] === "undefined") result.error[x.error] = 1;
                else result.error[x.error]++;
            }
        });
        var colors = Highcharts.getOptions().colors,
                categories = ['正确', '错误', '未提交'],
                data = [{
                    y: result.correct,
                    color: colors[2],
                    drilldown: {
                        name: '正确',
                        categories: ['正确'],
                        data: [result.correct],
                        color: colors[2]
                    }
                }, {
                    y: result.error_count,
                    color: colors[0],
                    drilldown: {
                        name: '错误',
                        categories: Object.keys(result.error),
                        data: Object.keys(result.error).map(function(key){return result.error[key];}),
                        color: colors[0]
                    }
                }, {
                    y: result.notsubmitted,
                    color: colors[1],
                    drilldown: {
                        name: '未提交',
                        categories: ['未提交'],
                        data: [result.notsubmitted],
                        color: colors[1]
                    }
                }],
                browserData = [],
                versionsData = [],
                i,
                j,
                dataLen = data.length,
                drillDataLen,
                brightness;


        // Build the data arrays
        for (i = 0; i < dataLen; i += 1) {

            // add browser data
            browserData.push({
                name: categories[i],
                y: data[i].y,
                color: data[i].color
            });

            // add version data
            drillDataLen = data[i].drilldown.data.length;
            for (j = 0; j < drillDataLen; j += 1) {
                brightness = 0.2 - (j / drillDataLen) / 5;
                versionsData.push({
                    name: data[i].drilldown.categories[j],
                    y: data[i].drilldown.data[j],
                    color: Highcharts.Color(data[i].color).brighten(brightness).get()
                });
            }
        }

        var chart = new Highcharts.Chart({
            chart: {
                type: 'pie',
                renderTo: 'homework-status-card-chart'
            },
            title: {
                text: ''
            },
            yAxis: {
                title: {
                    text: '评测结果'
                }
            },
            plotOptions: {
                pie: {
                    shadow: true,
                    center: ['50%', '50%']
                }
            },
            tooltip: {
                valueSuffix: ''
            },
            series: [{
                name: '人数',
                data: browserData,
                size: '60%',
                dataLabels: {
                    formatter: function () {
                        //return this.y > 5 ? this.point.name : null;
                        //return this.point.name;
                        return null;
                    },
                    color: '#ffffff',
                    distance: -30
                }
            }, {
                name: '人数',
                data: versionsData,
                size: '80%',
                innerSize: '60%',
                dataLabels: {
                    formatter: function () {
                        // display only if larger than 1
                        //return this.y > 1 ? '<b>' + this.point.name + ':</b> ' + this.y + '%' : null;
                        return '<b>' + this.point.name + ':</b> ' + this.y;
                    }
                }
            }]
        });
    });

</script>